<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
<!-- Estilos css -->
	<link rel="stylesheet" href="css/style.css"/>
    <link rel="stylesheet" href="css/leaflet.css">
	<link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    
	<title>Diatthew</title>
<!-- Plugin para Leaflet -->	
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" />
	<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
	
<!-- Plugin para Estilos Control de Capas -->	
	<link rel="stylesheet" href="Plugins/styledLayerControl.css"/>
	<script src="Plugins/styledLayerControl.js"></script>	
	
<!-- Plugin para Medición areas y distancias-->		
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.3.2/leaflet.draw.css" >
	<link rel="stylesheet" href="Plugins/leaflet-measure_files/leaflet-measure.css">

<!-- Plugin para zoom ventana-->		
	<script src="Plugins/leaflet-control-boxzoom.js"></script>
	<link rel="stylesheet" href="Plugins/leaflet-control-boxzoom.css" />	

<!-- Plugin para zoom casa-->	
	<link rel="stylesheet" href="Plugins/leaflet.zoomhome.css"/>
	<script src="Plugins/leaflet.zoomhome.min.js"></script>

<!-- Plugin para Impresión -->		
	 <link href='http://fonts.googleapis.com/css?family=Lato:900,300' rel='stylesheet' type='text/css'>
	<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

<!-- Leaflet Minimapa -->
	<link rel="stylesheet" href="Plugins/L.Control.MousePosition.css" />
	<link rel="stylesheet" href="Plugins/Control.MiniMap.css" />
	<script src="Plugins/L.Control.MousePosition.js" type="text/javascript"></script>
	<script src="Plugins/Control.MiniMap.js" type="text/javascript"></script>
	<style>
		html, #map {
			height:100%; 
		}
		.leaflet-popup-content {
			text-align: center;
			background:White;
			border-radius: 5px;
		}
		.leaflet-popup-content-wrapper{
			padding: 1px;
		}
		.leaflet-popup-tip {
			background:orange;
		}
	</style>
</head>
<body style ="height: 90%;">
	
    <nav class="navbar navbar-expand-lg bg-dark text-white">


            <a class="navbar-brand" style="color: white !important; font-style: underline !important;" href="#">  Prácticas de Tecnicas de información geográfica</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarText">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" style="color: white !important; font-style: underline !important;" href="#"><span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"style="color: white !important; font-style: underline !important;" href="#"></a>
                    </li>
                </ul>
                <span class="navbar-text">
                    <img class="logo" style="width:70px" src="./img/upv.jpg" alt="logo upv" />
                  </span>
            </div>
        </nav>
    <aside class="w-25 p-5">
            <h3>MAPAS</h3>
            <small><i>En este trabajo se observa el desarrollo llevado acabo en el laboratorio para el emprendimiento
				de las nuevas tecnologías para informar sobre la topográfia de españa. En el menú dentro del mapa a la derecha, encontramos:</i>
				<ul>
					<li>Bases comunes
						<ol>
							<li>Ortoimagen</li>
							<li>Base</li>
						</ol>
					</li>
					<li>Topográfico
						<ol>
							<li>Topográfico</li>
						</ol>
					</li>
					<li>Litología
						<ol>
							<li>España</li>
						</ol>
					</li>
					<li>Desastres naturales
						<ol>
							<li>Incendio Marxuquera</li>
						</ol>
					</li>
					<li>Repoblación
						<ol>
							<li>Aptitud 13</li>
							<li>Aptitud 14</li>
							<li>Aptitud 15</li>
						</ol>
					</li>
					<li>Precipitaciones
						<ol>
							<li>Lluvias del 2016</li>
						</ol>
					</li>
					<li>Temperaturas
						<ol>
							<li>Temperaturas del 2016</li>
						</ol>
					</li>
				</ul>
			</small>
    </aside>
	<!-- Mapa -->	
	<div id="map" class="w-80 border border-dark"></div>
    <!-- Footer -->
    <footer class="page-footer  bg-dark text-white" style="font-size:.8rem;">

        <!-- Copyright -->
        <div class="footer-copyright text-center py-3"> Grado en Tecnologias Interactivas <br />
                Diana Hernández Soler i Matthew Conde Oltra © 2019
        </div>
        <!-- Copyright -->

    </footer>
<!-- Footer -->
    
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
   <!-- <script src="data/contorno_1.js"></script> -->
    
<!-- Plugin para medición -->	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.3.2/leaflet.draw.js"></script>
	<script src="Plugins/leaflet-measure.js"></script>
	
<!-- Plugin para llamar a PNOA -->
	<script src="Plugins/Leaflet.Spain.WMS.js"></script>
	<script src="Plugins/leaflet.wms.js"></script>
<!-- Plugin para Impresión -->	
	<script src="Plugins/bundle.js"></script>
<!-- Cargamos Esri Leaflet -->
	<script src="https://unpkg.com/esri-leaflet@2.2.3/dist/esri-leaflet.js"></script>
	<script src="Plugins/leaflet.shpfile.js"></script>
	<script src="Plugins/shp.js"></script>
	<script src="Plugins/leaflet-providers.js"></script>
<!-- GeoTIFF library -->
<!-- Cargamos Geotiff -->
	<script src = " //cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js " > </script>
	<script src = " //d3js.org/d3.v4.min.js " > </script>
	<script src = " //npmcdn.com/geotiff@0.3.6/dist/geotiff.js "></script>
	<script src = " https://ihcantabria.github.io/Leaflet.CanvasLayer.Field/dist/leaflet.canvaslayer.field.js " ></script>

<!-- Configuración mapa y sus elementos -->	
    <script>
        var map = L.map('map', {center: [39.9233, -0.6139],zoom: 15, zoomControl:false});
		
        /*var map = L.map('map', {
            zoomControl:true, maxZoom:28, minZoom:1
        }).fitBounds([[34.625577273472004,-12.519391557437247],[45.72683053663241,11.058608395715913]]);*/

        var inicial = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
		var zoomHome = L.Control.zoomHome();
			zoomHome.addTo(map);

        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var bounds_group = new L.featureGroup([]);
        
        function setBounds() {}
        
        var img_incendio_1 = 'data/incendio_1.png';
        var img_bounds_incendio_1 = [[38.940827497120885,-0.34859756632133443],[39.002692542436,-0.24808798876083304]];
        var layer_incendio_1 = new L.imageOverlay(img_incendio_1, img_bounds_incendio_1);
        bounds_group.addLayer(layer_incendio_1);
        //map.addLayer(layer_incendio_1);
        
		//Topografico
		var OpenTopoMap = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {maxZoom: 17,
			attribution: 'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
		});

		//Array de plantas afectadas
		var plants = ["Tejido urbano discontinuo", "Frutales", "Olivares", "Mosaico de cultivos", 
		"Terrenos principalmente agrícolas, pero con importantes espacios de vegetación natural", 
		"Bosques de frondosas", "Bosques de coníferas", "Pastizales naturales", "Vegetación esclerófila", 
		"Matorral boscoso de transición", "Espacios con vegetación escasa", "Zonas quemadas"];

		// Shapefiles

		var litologia = new L.Shapefile('LITOLOGIA.zip',{
			onEachFeature: function(feature,marker) {
			//console.log(feature.properties);
			marker.bindPopup("<h4>"+feature.properties.Nombre+"</h4><br/><i><b>Capital: </b>"+feature.properties.Capital+"<br/><i><b>Área: </b>"
			+Math.round(feature.properties.Shape_Area/1000000)+" km<sup>2</sup>");
		}});

		var incendioMarxuquera = new L.Shapefile('INCENDIO.zip',{
			onEachFeature: function(feature,marker) {
			//console.log(feature.properties);
			marker.bindPopup("<i><b>Parcela número: </b>" +feature.properties.Id+"<br/><i><b>Descripción: </b>"+plants[feature.properties.gridcode]);
		}});

		var layer_apt_13 = new L.Shapefile('13.zip',{
			onEachFeature: function(feature,marker) {
			
			marker.bindPopup("<i><b>Aptitud: </b>"+feature.properties.Aptitud+"<br/><i><b>Área: </b>"+feature.properties.Área+" m<sup>2</sup>");
		}});

		var layer_apt_14 = new L.Shapefile('14.zip',{
			onEachFeature: function(feature,marker) {
			marker.bindPopup("<h3>Parcela (con aptitud): " +feature.properties.Aptitud+"</h3><i><b>Área: </b>"+feature.properties.Área+" m<sup>2</sup>");
		}});

		var layer_apt_15 = new L.Shapefile('15.zip',{
			onEachFeature: function(feature,marker) {
			marker.bindPopup("<h3>Parcela (con aptitud): " +feature.properties.Aptitud+"</h3><i><b>Área: </b>"+feature.properties.Área+" m<sup>2</sup>");
		}});

        // Menu de capas
		var baseMaps = [{
		groupName : "Bases comunes",
		layers : {
				"Ortoimagen" : Spain_PNOA_Ortoimagen,
				"Base": Spain_IGNBase,
				}
		}, {
		
		groupName : "Topografico",
		layers : {
			"Topografico" :OpenTopoMap,
			}
		}];
		
		var overlays = [{
		groupName : "Litologia",
		layers : {
			"España" : litologia
			}
		}, {
		groupName : "Desastres naturales",
		layers : {
			"Incendio" : incendioMarxuquera
			}
		}, {
		groupName: "Repoblación",
		layers : {
			"APT_13": layer_apt_13,
			"APT_14": layer_apt_14,
			"APT_15": layer_apt_15
			}
		}
		];


        var options = {
			container_width : "300px",
			group_maxHeight : "80px",
			exclusive : false,
			collapsed : true,
			position: 'topright'
            };
            

            
		var control = L.Control.styledLayerControl(baseMaps, overlays, options);


	//GeoTiff precipitaciones
	var tiff = "http://personales.alumno.upv.es/juconol/PRECI.tif";
			fetch(tiff).then(r => r.arrayBuffer()).then(function(buffer) {
			var s = L.ScalarField.fromGeoTIFF(buffer);
			let layer = L.canvasLayer.scalarField(s, {
					color: chroma.scale(['white', 'blue', 'black']).domain(s.range),
					opacity: 0.60
				});//.addTo(map);
			layer.on("click", function(e) {
				if (e.value !== null) {
				var volumen = Math.round(e.value);
				let popup = L.popup()
				.setLatLng(e.latlng)
				.setContent(volumen+" l/m<sup>2</sup>")
				//.setContent(`${e.value}`)
				.openOn(map);
				}
			});
			control.addOverlay(layer, "Lluvias", {
					groupName: "Precipitaciones",
				});

        });

	//GeoTiff temperaturas
	var tiffTemperatura = "http://personales.alumno.upv.es/juconol/TEMP.tif";
			fetch(tiffTemperatura).then(r => r.arrayBuffer()).then(function(buffer) {
			var sTemperatura = L.ScalarField.fromGeoTIFF(buffer);
			let layerTemperatura = L.canvasLayer.scalarField(sTemperatura, {
					color: chroma.scale(['green','yellow', 'orange', 'red']).domain(sTemperatura.range),
					opacity: 0.60
				});//.addTo(map);
			layerTemperatura.on("click", function(e) {
				if (e.value !== null) {
				var temp = Math.round(e.value);
				let popup = L.popup()
				.setLatLng(e.latlng)
				.setContent(temp+" <sup>o</sup>C")
				.openOn(map);
				}
			});
			control.addOverlay(layerTemperatura, "Temperaturas", {
					groupName: "Temp_2016",
				});

        });

		map.addControl(control);
		
		var measureControl = new L.Control.Measure({
			position:'topleft',
			primaryLengthUnit: 'meters', 
			secondaryLengthUnit: 'kilometers',
			primaryAreaUnit:'hectares',
			activeColor: 'red',
			completedColor: 'blue'
		});
		measureControl.addTo(map);

		var regla = document.getElementsByClassName('leaflet-control-measure-toggle')[0];
        regla.innerHTML = "";

        //Botón para impresión
        var printer = L.easyPrint({
					  tileLayer: inicial,
					  sizeModes: ['Current'],
					  filename: 'Mapa',
					  exportOnly: true,
					  hideControlContainer: true
		}).addTo(map);
		

        var osm2 = new L.TileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png');
        //MiniMapa
		var miniMap = new L.Control.MiniMap(osm2, { toggleDisplay: true, zoomLevelOffset: -8 }).addTo(map);
		
		var position= new L.Control.MousePosition({position:'bottomleft', separator:'--', prefix:'Coordenadas Lat--Lon : '}).addTo(map);
		
		var escala = L.control.scale({ position: 'bottomleft', metric: true, maxWidth: 200}).addTo(map);
		
		var zoomBox = L.Control.boxzoom({ position:'topleft' }).addTo(map);
		
		/*var source = L.WMS.source('https://ovc.catastro.meh.es/Cartografia/WMS/ServidorWMS.aspx?', {
			opacity: 0.1,
			info_format: "text/html"
		});
		source.getLayer("PARCELA").addTo(map);*/

	</script>
</body>
</html>
